<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فال حافظ</title>
    <meta name="robots" content="noindex">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/main.css">

</head>

<body>
    <style>
        * {
            direction: rtl;
        }
    </style>

    <section class="hero">
        <div class="col-big">
            <h4>چطور فال حافظ بگیریم ؟</h4>
            <p>
                روش صحیح گرفتن فال حافظ
                یک نفر از بزرگان خانواده یا کسی که بتواند شعر را به خوبی بخواند یا کسی که دیگران معتقدند به اصطلاح خوب
                فال می‌گیرد ابتدا نیت می‌کند، یعنی در دل آرزویی می‌کند. سپس به طور تصادفی صفحه‌ای را از کتاب حافظ
                می‌گشاید و با صدای بلند شروع به خواندن می‌کند. کسانی که ایمان مذهبی داشته باشند هنگام فال گرفتن فاتحهای
                می‌خوانند و سپس کتاب حافظ را می‌بوسند، آنگاه با ذکر اورادی آن را می‌گشایند و فال خود را می‌خوانند.
                نیت کننده معمولاً در هنگام تفأل از دیوان حافظ، او را به عزیزترین کسانش یعنی به خداوند و معشوقه اش (شاخ
                نبات) قسم می دهد. این قسم معمولاً به این شکل ادا می شود (ضمن اینکه شاید بهتر باشد برای شادی روح حافظ،
                صلوات یا فاتحه ای نثار نماییم):</p>
        </div>

        <div class="col-med">
            <img src="/static/hafeziee.png" />
        </div>
    </section>

    <section>
        <img src="/static/pem.jpg" class="center-image" />
    </section>

    <div class="fal-content">
        <h1></h1>
        <div class="org-content"></div>
        <audio controls hidden></audio>
    </div>
    <button type="button" class="faal">نیت کنید و کلیک کنید.<i></i></button>

    <script>

        // تابع دریافت داده از سرور
        async function getFal(id = null) {
            let url = '/falfront';
            if (id) {
                url = `/falfront/${id}`;
            }

            const res = await fetch(url);

            if (!res.ok) {
                throw new Error(`خطا در درخواست - وضعیت: ${res.status}`);
            }

            return await res.json();
        }

        // نمایش فال با فرمت کتاب‌مانند
        function showFal(data) {
            if (!data?.ok) {
                alert(data?.message || 'خطایی رخ داد');
                return;
            }

            document.querySelector('h1').textContent = data.title || 'غزل حافظ';

            const contentEl = document.querySelector('.org-content');
            const audioEl = document.querySelector('audio');

            if (data.poem && data.interpretation) {
                // تبدیل شعر به بیت‌های دو مصراعی
                const lines = data.poem.trim().split('\n').filter(line => line.trim());

                let poemHTML = '';
                for (let i = 0; i < lines.length; i += 2) {
                    const mesra1 = lines[i] || '';
                    const mesra2 = lines[i + 1] || '';
                    poemHTML += `
            <div class="beyt">
              <div class="mesra">${mesra1}</div>
              <div class="mesra">${mesra2}</div>
            </div>
          `;
                }

                contentEl.innerHTML = `
          <div class="poem">${poemHTML}</div>
          <div class="interpretation">
            <strong>تعبیر غزل:</strong>
            ${data.interpretation.replace(/\n/g, '<br><br>')}
          </div>
        `;
            } else if (data.content) {
                contentEl.innerHTML = data.content;
            } else {
                contentEl.innerHTML = '<p>محتوا یافت نشد</p>';
            }

            if (data.src) {
                audioEl.src = data.src;
                audioEl.hidden = false;
            }
        }

        // اجرای اصلی بعد از لود صفحه
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            const falButton = document.querySelector('.faal');

            // اگر id در URL بود → فال را خودکار بگیر و نمایش بده
            if (id) {
                try {
                    const data = await getFal(id);
                    showFal(data);

                    // غیرفعال کردن دکمه
                    falButton.disabled = true;
                    falButton.style.opacity = '0.6';
                    falButton.textContent = 'فال نمایش داده شد';
                } catch (err) {
                    console.error(err);
                    alert('خطا در بارگذاری فال خودکار');
                }
            }

            // کلیک روی دکمه فال (بدون id → حالت معمولی)
            falButton.addEventListener('click', async () => {
                try {
                    falButton.disabled = true;
                    let seconds = 16;
                    falButton.querySelector('i').innerHTML = seconds;

                    const interval = setInterval(() => {
                        seconds--;
                        falButton.querySelector('i').innerHTML = seconds;
                        if (seconds <= 0) {
                            clearInterval(interval);
                        }
                    }, 1000);

                    const data = await getFal(); // بدون id
                    showFal(data);

                    // بعد از 16 ثانیه دوباره فعال شود
                    setTimeout(() => {
                        falButton.disabled = false;
                        falButton.querySelector('i').innerHTML = '';
                        falButton.textContent = 'گرفتن فال دوباره';
                    }, 16000);

                } catch (err) {
                    console.error(err);
                    alert('خطایی رخ داد');
                    falButton.disabled = false;
                    falButton.querySelector('i').innerHTML = '';
                }
            });
        });
    </script>
</body>

</html>